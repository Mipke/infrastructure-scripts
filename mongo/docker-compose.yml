version: "3.0"

volumes:
  mongo-keys:

networks:
  default:
    external:
      name: mongo

services:
  mongo-keys-service:
    image: depop/openssl-bats
    volumes:
      - mongo-keys:/mongo-conf
    command: 'bash -c "openssl rand -base64 741 > /mongo-conf/mongodb-keyfile; chmod 600 /mongo-conf/mongodb-keyfile; chown 999 /mongo-conf/mongodb-keyfile"'

  mongo1:
    image: mongo:4.4.1
    volumes:
      - mongo-keys:/opt/keyfile
      - /mnt/volume_nyc3_01:/data/db
    env_file:
      ./mongod.env
    ports:
      - 27017:27017
    command: 'mongod --auth --keyFile /opt/keyfile/mongodb-keyfile --replSet rs0'
    depends_on:
      - mongo-keys-service
    deploy:
      placement:
        constraints:
          - "node.labels.mongo.replica == 1"

  mongo2:
    image: mongo:4.4.1
    volumes:
      - mongo-keys:/opt/keyfile
      - /mongo/data:/data/db
    env_file:
      ./mongod.env
    ports:
      - 27018:27017
    command: 'mongod --auth --keyFile /opt/keyfile/mongodb-keyfile --replSet rs0'
    depends_on:
      - mongo-keys-service
    deploy:
      placement:
        constraints:
          - "node.labels.mongo.replica == 2"

  mongo3:
    image: mongo:4.4.1
    volumes:
      - mongo-keys:/opt/keyfile
      - /mongo/data:/data/db
    env_file:
      ./mongod.env
    ports:
      - 27019:27017
    command: 'mongod --auth --keyFile /opt/keyfile/mongodb-keyfile --replSet rs0'
    depends_on:
      - mongo-keys-service
    deploy:
      placement:
        constraints:
          - "node.labels.mongo.replica == 3"